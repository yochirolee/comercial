generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==========================================
// USUARIO - Autenticación del sistema
// ==========================================
model Usuario {
  id               String   @id @default(cuid())
  nombre           String
  apellidos        String
  telefono         String?
  email            String   @unique
  password         String
  rol              String   @default("comercial") // "admin" o "comercial"
  activo           Boolean  @default(true)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  resetTokens      PasswordResetToken[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  usuarioId String
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  
  createdAt DateTime @default(now())
}

model Empresa {
  id               String   @id @default(cuid())
  nombre           String
  direccion        String?
  telefono         String?
  email            String?
  nit              String?
  representante    String?
  cargoRepresentante String?
  codigoMincex     String?
  logo             String?
  firmaPresidente  String?
  cunoEmpresa      String?
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Cliente {
  id               String   @id @default(cuid())
  nombre           String
  apellidos        String?
  contacto         String?
  nombreCompania   String?
  direccion        String?
  telefono         String?
  email            String?
  nit              String?
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  ofertasCliente        OfertaCliente[]
  ofertasImportadora    OfertaImportadora[]
  facturas              Factura[]
  importadoras          ClienteImportadora[]
}

model UnidadMedida {
  id               String   @id @default(cuid())
  nombre           String
  abreviatura      String
  usaCajas         Boolean  @default(false)
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  productos        Producto[]
}

model Producto {
  id               String   @id @default(cuid())
  codigo           String?  @unique
  nombre           String
  descripcion      String?
  precioBase       Float
  unidadMedidaId   String
  unidadMedida     UnidadMedida @relation(fields: [unidadMedidaId], references: [id])
  codigoArancelario String?
  activo           Boolean  @default(true)
  
  // Campos informativos para precarga en ofertas
  cantidad         Float?
  cantidadCajas    Float?
  cantidadSacos    Float?
  pesoNeto         Float?
  pesoBruto        Float?
  pesoXSaco        Float?
  precioXSaco      Float?
  pesoXCaja        Float?
  precioXCaja      Float?
  usoPrevisto      String?  // Uso previsto del producto (texto descriptivo)
  
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  itemsOfertaGeneral         ItemOfertaGeneral[]
  itemsOfertaCliente         ItemOfertaCliente[]
  itemsOfertaImportadora     ItemOfertaImportadora[]
  itemsFactura               ItemFactura[]
}

model OfertaGeneral {
  id               String   @id @default(cuid())
  numero           String   @unique
  fecha            DateTime @default(now())
  vigenciaHasta    DateTime?
  observaciones    String?
  estado           String   @default("pendiente")
  total            Float    @default(0)
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items            ItemOfertaGeneral[]
}

model ItemOfertaGeneral {
  id               String   @id @default(cuid())
  ofertaGeneralId  String
  ofertaGeneral    OfertaGeneral @relation(fields: [ofertaGeneralId], references: [id], onDelete: Cascade)
  productoId       String
  producto         Producto @relation(fields: [productoId], references: [id])
  descripcion      String?
  cantidad         Float
  precioUnitario   Float
  subtotal         Float
  cantidadCajas    Float?
  cantidadSacos    Float?
  pesoNeto         Float?
  pesoBruto        Float?
  pesoXSaco        Float?
  precioXSaco      Float?
  pesoXCaja        Float?
  precioXCaja      Float?
  codigoArancelario String?
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model OfertaCliente {
  id               String   @id @default(cuid())
  numero           String   @unique
  fecha            DateTime @default(now())
  vigenciaHasta    DateTime?
  clienteId        String
  cliente          Cliente  @relation(fields: [clienteId], references: [id])
  observaciones    String?
  estado           String   @default("pendiente")
  codigoMincex     String?
  puertoEmbarque   String?  @default("NEW ORLEANS, LA")
  origen           String?  @default("ESTADOS UNIDOS")
  moneda           String?  @default("USD")
  terminosPago     String?  @default("PAGO 100% ANTES DEL EMBARQUE")
  incluyeFirmaCliente Boolean @default(false)
  total            Float    @default(0)
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items            ItemOfertaCliente[]
  ofertasImportadora OfertaImportadora[]
  operations       Operation[]
}

model ItemOfertaCliente {
  id               String   @id @default(cuid())
  ofertaClienteId  String
  ofertaCliente    OfertaCliente @relation(fields: [ofertaClienteId], references: [id], onDelete: Cascade)
  productoId       String
  producto         Producto @relation(fields: [productoId], references: [id])
  descripcion      String?
  cantidad         Float
  precioUnitario   Float
  subtotal         Float
  cantidadCajas    Float?
  cantidadSacos    Float?
  pesoNeto         Float?
  pesoBruto        Float?
  pesoXSaco        Float?
  precioXSaco      Float?
  pesoXCaja        Float?
  precioXCaja      Float?
  codigoArancelario String?
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model OfertaImportadora {
  id               String   @id @default(cuid())
  numero           String   @unique
  fecha            DateTime @default(now())
  vigenciaHasta    DateTime?
  clienteId        String
  cliente          Cliente  @relation(fields: [clienteId], references: [id])
  importadoraId    String?
  importadora      Importadora? @relation(fields: [importadoraId], references: [id])
  observaciones    String?
  estado           String   @default("pendiente")
  ofertaClienteId  String?
  ofertaCliente    OfertaCliente? @relation(fields: [ofertaClienteId], references: [id])
  codigoMincex     String?
  puertoEmbarque   String?  @default("NEW ORLEANS, LA")
  origen           String?  @default("ESTADOS UNIDOS")
  moneda           String?  @default("USD")
  terminosPago     String?  @default("PAGO 100% ANTES DEL EMBARQUE")
  incluyeFirmaCliente Boolean @default(false)
  flete            Float    @default(0)
  seguro           Float    @default(0)
  tieneSeguro      Boolean  @default(false)
  subtotalProductos Float   @default(0)
  precioCIF        Float    @default(0)
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items            ItemOfertaImportadora[]
}

model ItemOfertaImportadora {
  id               String   @id @default(cuid())
  ofertaImportadoraId String
  ofertaImportadora OfertaImportadora @relation(fields: [ofertaImportadoraId], references: [id], onDelete: Cascade)
  productoId       String
  producto         Producto @relation(fields: [productoId], references: [id])
  descripcion      String?
  cantidad         Float
  precioOriginal   Float
  precioAjustado   Float
  subtotal         Float
  cantidadCajas    Float?
  cantidadSacos    Float?
  pesoNeto         Float?
  pesoBruto        Float?
  pesoXSaco        Float?
  precioXSaco      Float?
  pesoXCaja        Float?
  precioXCaja      Float?
  codigoArancelario String?
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Factura {
  id               String   @id @default(cuid())
  numero           String   @unique
  fecha            DateTime @default(now())
  fechaVencimiento DateTime?
  clienteId        String
  cliente          Cliente  @relation(fields: [clienteId], references: [id])
  importadoraId    String?
  importadora      Importadora? @relation(fields: [importadoraId], references: [id])
  observaciones    String?
  estado           String   @default("pendiente")
  
  // Campos de costos
  subtotal         Float    @default(0)
  flete            Float    @default(0)
  seguro           Float    @default(0)
  tieneSeguro      Boolean  @default(false)
  impuestos        Float    @default(0)
  descuento        Float    @default(0)
  total            Float    @default(0)
  
  // Términos y condiciones
  codigoMincex     String?
  nroContrato      String?
  puertoEmbarque   String?  @default("NEW ORLEANS, LA")
  origen           String?  @default("ESTADOS UNIDOS")
  moneda           String?  @default("USD")
  terminosPago     String?  @default("PAGO 100% ANTES DEL EMBARQUE")
  
  // Firmas
  incluyeFirmaCliente Boolean @default(false)
  firmaClienteNombre  String?
  firmaClienteCargo   String?
  firmaClienteEmpresa String?
  
  // Origen
  tipoOfertaOrigen String?
  ofertaOrigenId   String?
  
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items            ItemFactura[]
  operations       Operation[]
}

model ItemFactura {
  id               String   @id @default(cuid())
  facturaId        String
  factura          Factura  @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  productoId       String
  producto         Producto @relation(fields: [productoId], references: [id])
  descripcion      String?
  cantidad         Float
  cantidadCajas    Float?
  cantidadSacos    Float?
  pesoNeto         Float?
  pesoBruto        Float?
  precioUnitario   Float
  subtotal         Float
  pesoXSaco        Float?
  precioXSaco      Float?
  pesoXCaja        Float?
  precioXCaja      Float?
  codigoArancelario String?
  campoExtra1      String?
  campoExtra2      String?
  campoExtra3      String?
  campoExtra4      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ==========================================
// OPERATIONS - Tracking de operaciones
// ==========================================
model Operation {
  id                String   @id @default(cuid())
  operationNo       String   @unique
  operationType     String   // COMMERCIAL | PARCEL
  offerCustomerId   String?
  offerCustomer     OfertaCliente? @relation(fields: [offerCustomerId], references: [id])
  importadoraId     String?
  importadora       Importadora? @relation(fields: [importadoraId], references: [id])
  invoiceId         String?
  invoice           Factura? @relation(fields: [invoiceId], references: [id])
  status            String
  currentLocation   String?
  originPort        String?
  destinationPort   String?
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  containers        OperationContainer[]
  events            OperationEvent[]
}

model OperationContainer {
  id                String   @id @default(cuid())
  operationId       String
  operation         Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  sequenceNo        Int
  containerNo       String?
  bookingNo         String?
  blNo              String?
  originPort        String?
  destinationPort   String?
  etdEstimated      DateTime?
  etaEstimated      DateTime?
  etdActual         DateTime?
  etaActual         DateTime?
  status            String
  currentLocation   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  events            ContainerEvent[]
}

model OperationEvent {
  id                String   @id @default(cuid())
  operationId       String
  operation         Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  eventType         String
  title             String
  description       String?
  eventDate         DateTime
  fromStatus        String?
  toStatus          String?
  createdBy         String?
  
  createdAt         DateTime @default(now())
}

model ContainerEvent {
  id                String   @id @default(cuid())
  operationContainerId String
  operationContainer OperationContainer @relation(fields: [operationContainerId], references: [id], onDelete: Cascade)
  eventType         String
  title             String
  description       String?
  eventDate         DateTime
  fromStatus        String?
  toStatus          String?
  location          String?
  createdBy         String?
  
  createdAt         DateTime @default(now())
}

// ==========================================
// IMPORTADORA - Consignee
// ==========================================
model Importadora {
  id                    String   @id @default(cuid())
  nombre                String
  direccion             String?
  pais                  String?  @default("Cuba")
  puertoDestinoDefault  String?  @default("MARIEL, Cuba")
  contacto              String?
  telefono              String?
  email                 String?
  notas                 String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  clientes              ClienteImportadora[]
  ofertasImportadora    OfertaImportadora[]
  facturas              Factura[]
  operaciones           Operation[]
  
  @@index([nombre])
}

// ==========================================
// RELACIÓN MUCHOS-A-MUCHOS: Cliente ↔ Importadora
// ==========================================
model ClienteImportadora {
  id            String   @id @default(cuid())
  clienteId     String
  cliente       Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  importadoraId String
  importadora   Importadora @relation(fields: [importadoraId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([clienteId, importadoraId])
  @@index([clienteId])
  @@index([importadoraId])
}
